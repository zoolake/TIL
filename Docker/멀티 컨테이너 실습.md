# Travis CI

**이번 실습에서 Travis CI 가 하는 역할의 흐름은 다음과 같다.**

1. Github에 코드를 푸시한다.
2. Travis CI 가 자동으로 해당 레포지토리의 코드를 가져온다.
3. 가져온 코드의 테스트 코드를 실행한다.
4. 만약 (3)에서 실행한 테스트가 성공하면, 운영 환경의 이미지를 빌드한다.
5. 빌드된 이미지를 도커 허브에 업로드
   - AWS에서 도커 허브에 업로드 된 이미지를 들고간다.
   - 도커 허브에서는 기존 다른 어플리케이션의 이미지 뿐만 아니라, 자신이 만든 이미지도 업로드할 수 있다.
6. AWS Elastic Beanstalk 에 도커 허브에 이미지를 업로드 했다고 알린다.
7. AWS Elastic Beanstalk 가 도커 허브에 업로드 된 이미지를 가져온 후 배포한다.

# travis.yml 파일 작성

**작성하기 전 전반적인 흐름을 먼저 살펴보자.**

1. 파일을 생성
   - 파일명은 `.travis.yml`
2. Test를 수행하기 위한 준비
   - 앱을 도커 환경에서 실행하고 있으므로, Travis CI에게 도커 환경으로 만들 것 이라고 선언
   - 구성된 도커 환경에서 `Dockerfile.dev`를 이용하여 도커 이미지 생성
3. Test 수행
   - 생성된 테스트 이미지를 이용하여 테스트를 수행
4. 모든 프로젝트의 운영 환경 이미지들을 빌드
   - 위의 테스트가 성공했다면 각 프로젝트의 운영 환경 이미지를 빌드하는 설정을 진행
5. 빌드된 이미지를 도커 허브에 업로드
   - 빌드된 이미지를 도커 허브에 올리기 위해 도커 허브에 로그인
   - 빌드된 이미지를 도커 허브에 업로드 진행
6. 배포
   - AWS Elastic Beanstalk 이 도커 허브에 업로드된 이미지를 가져와서 배포 할 수 있게 설정

**위 순서를 따라 YAML 파일을 작성해 보면 다음과 같다.**

```yaml
language: generic

sudo: required

services:
  - docker

before_install:
  - docker build -t zoolake/react-test-app -f ./frontend/Dockerfile.dev ./frontend

sciprt:
  - docker run -e CI=true zoolake/react-test-app npm run test

after_success:
  - docker build -t zoolake/docker-frontend ./frontend
  - docker build -t zoolake/docker-backend ./backend
  - docker build -t zoolake/docker-nginx ./nginx

  - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_ID" --password-stdin

  - docker push zoolake/docker-frontend
  - docker push zoolake/docker-backend
  - docker push zoolake/docker-nginx
```

- language : 언어 (플랫폼) 선택
- sudo : 관리자 권한 갖기
- services : 도커 환경 구성
- before_install : 스크립트를 실행할 수 있는 환경 구성
  - docker build -t <이미지 이름> -f <Dockerfile 경로> <빌드할 파일들이 있는 경로>
  - 위 명령어와 관련해서 [도커 공식문서 : Specify a Dockerfile (-f)](https://docs.docker.com/engine/reference/commandline/build/#specify-a-dockerfile--f)를 확인해보면 도움이 된다.
- script : 실행할 스크립트 (여기서는 테스트 실행)
- after_success : 테스트 성공 후 할 일
  - 각각의 이미지를 빌드
  - 도커 허브에 로그인
    - ID와 Password 는 Travis CI 에서 환경변수를 미리 만들어 두어 관리한다.
  - 빌드 된 이미지를 도커 허브에 업로드
